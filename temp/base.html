{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Page Title{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"> -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<div id="welcome-bot-overlay">
  <div class="welcome-bot-container">
    <img id="welcomeBotAvatar" src="/static/img/doctor_avatar.png" class="welcome-bot-avatar">
    <h2>Hey, I‚Äôm <span style="color:#5ec3eb;">Dr. MediBot</span></h2>
    <p>I‚Äôm here to assist you. Tell me if you need anything!</p>
  </div>
</div>

<div class="chatbox-container">
  <div class="chat-toggle">
    <img src="/static/img/doctor_avatar.png" class="chat-avatar">
  </div>

  <div class="chat-window" id="chatWindow">
    <div class="chat-header">üë®‚Äç‚öïÔ∏è Dr. MediBot</div>

    <div class="chat-messages" id="chatMessages"></div>

    <!-- Typing Indicator -->
    <div class="typing-indicator" id="typingIndicator">
      <span></span><span></span><span></span>
    </div>

    <div class="chat-input-area">
      <input class="chat-input" id="chatInput" placeholder="Ask me anything‚Ä¶">
      <button class="send-btn" id="sendBtn">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<body>
  <!-- Header -->
  <header>

    <!-- Logo -->
    <div class="header-logo">
      <a href="{% url 'home' %}">
        <img src="/static/img/Capsul Logo Mark (1).jpeg" alt="Midiset Logo" />
      </a>
    </div>

    <!-- DESKTOP NAV (unchanged) -->
    <nav class="header-nav-links desktop-nav">
      <ul>
        <li>
          <a href="#">Medicines <i class="fas fa-caret-down arrow"></i></a>
          <ul class="Med-dropdown dropdown">
            {% for category in categories %}
            <li><a href="{% url 'product_list' %}?category={{ category.id }}">{{ category.name }}</a></li>
            {% endfor %}
          </ul>
        </li>

        <li>
          <a href="{% url 'labtest' %}">Lab Test <i class="fas fa-caret-down arrow"></i></a>
          <ul class="dropdown Lab-dropdown">
            {% for service in pharmacy_services %}
            <li><a href="{% url 'labtest' %}#labtest-section">{{ service.name }}</a></li>
            {% endfor %}
          </ul>
        </li>

        <li>
          <a href="{% url 'consultdoc' %}">Consult Doctors <i class="fas fa-caret-down arrow"></i></a>
          <ul class="dropdown">
            <li><a href="#">Online</a></li>
            <li><a href="#">In Clinic</a></li>
          </ul>
        </li>

        <li><a href="{% url 'cancercare' %}">Cancer Care</a></li>
        <li><a href="{% url 'ayurveda' %}">Ayurveda <i class="fas fa-caret-down arrow"></i></a>
          <ul class="dropdown">
            <li><a href="{% url 'product_list' %}?category=27">Herbal Products</a></li>
          </ul>
        </li>

        <li><a href="{% url 'partnership' %}">Partnership</a></li>
        <li><a href="{% url 'careplan' %}">Care Plan</a></li>
      </ul>
    </nav>

    <!-- DESKTOP ICONS (unchanged) -->
    <div class="header-icons desktop-icons">

      <div class="user-dropdown">
        <i class="fas fa-user"></i>
        <ul class="user-menu">
          {% if user.is_authenticated %}
          <li>
            <form method="POST" action="{% url 'logout' %}">
              {% csrf_token %}
              <button type="submit" class="logout-btn">Logout</button>
            </form>
          </li>
          <li><a href="{% url 'profile' %}">My Profile</a></li>
          {% else %}
          <li><a href="{% url 'login' %}">Login</a></li>
          <li><a href="{% url 'signup' %}">Sign Up</a></li>
          {% endif %}
        </ul>
      </div>

      <a href="{% url 'wishlist' %}" class="wishlist-icon">
        <i class="fas fa-heart"></i>
        {% if wishlist_count > 0 %}
        <span class="wishlist-count">{{ wishlist_count }}</span>
        {% endif %}
      </a>

      <a href="{% url 'cart' %}" class="cart-icon">
        <i class="fas fa-shopping-cart"></i>
        {% if cart_count > 0 %}
        <span class="cart-count">{{ cart_count }}</span>
        {% endif %}
      </a>

      <i class="fas fa-location-dot"></i>
    </div>

    <!-- MOBILE TOGGLER -->
    <div class="mobile-toggle" id="mobileToggle">
      <span></span><span></span><span></span>
    </div>

    <nav class="mobile-slide-menu" id="mobileMenu">

      <!-- MOBILE NAVIGATION -->
      <ul class="mobile-nav-list">

        <!-- Medicines -->
        <li class="mobile-dropdown-item">
          <button class="mobile-dropdown-toggle">
            Medicines <i class="fas fa-caret-down"></i>
          </button>
          <ul class="mobile-dropdown">
            {% for category in categories %}
            <li><a href="{% url 'product_list' %}?category={{ category.id }}">{{ category.name }}</a></li>
            {% endfor %}
          </ul>
        </li>

        <!-- Lab Test -->
        <li class="mobile-dropdown-item">
          <button class="mobile-dropdown-toggle" onclick="window.location.href='/labtest'">
            Lab Test <i class="fas fa-caret-down"></i>
          </button>
          <ul class="mobile-dropdown">
            {% for service in pharmacy_services %}
            <li><a href="">{{ service.name }}</a></li>
            {% endfor %}
          </ul>
        </li>

        <!-- Consult Doctors -->
        <li class="mobile-dropdown-item">
          <button class="mobile-dropdown-toggle" onclick="window.location.href='/consultdoc'">
            Consult Doctors <i class="fas fa-caret-down"></i>
          </button>
          <ul class="mobile-dropdown">
            <li><a href="#">Online</a></li>
            <li><a href="#">In Clinic</a></li>
          </ul>
        </li>

        <!-- Cancer Care -->
        <li><a href="{% url 'cancercare' %}">Cancer Care</a></li>

        <!-- Ayurveda -->
        <li class="mobile-dropdown-item">
          <button class="mobile-dropdown-toggle" onclick="window.location.href='/ayurveda'">
            Ayurveda <i class="fas fa-caret-down"></i>
          </button>
          <ul class="mobile-dropdown">
            <li><a href="{% url 'product_list' %}?category=27">Herbal Products</a></li>
          </ul>
        </li>

        <!-- Others -->
        <li><a href="{% url 'partnership' %}">Partnership</a></li>
        <li><a href="{% url 'careplan' %}">Care Plan</a></li>

      </ul>

      <!-- MOBILE ICONS WITH LINKS AND COUNTS -->
      <div class="mobile-icons">

        <!-- USER -->
        <div class="mobile-user">
          <button class="mobile-user-toggle">
            <i class="fas fa-user"></i>
            <i class="fas fa-caret-down"></i>
          </button>

          <ul class="mobile-user-menu">
            {% if user.is_authenticated %}
            <li>
              <form method="POST" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="logout-btn">Logout</button>
              </form>
            </li>
            <li><a href="{% url 'profile' %}">My Profile</a></li>
            {% else %}
            <li><a href="{% url 'login' %}">Login</a></li>
            <li><a href="{% url 'signup' %}">Sign Up</a></li>
            {% endif %}
          </ul>
        </div>

        <!-- Wishlist -->
        <a href="{% url 'wishlist' %}" class="mobile-wishlist">
          <i class="fas fa-heart"></i>
          {% if wishlist_count > 0 %}
          <span class="wishlist-count">{{ wishlist_count }}</span>
          {% endif %}
        </a>

        <!-- Cart -->
        <a href="{% url 'cart' %}" class="mobile-cart">
          <i class="fas fa-shopping-cart"></i>
          {% if cart_count > 0 %}
          <span class="cart-count">{{ cart_count }}</span>
          {% endif %}
        </a>

        <!-- Location -->
        <a href="#" class="mobile-location">
          <i class="fas fa-location-dot"></i>
        </a>

      </div>

    </nav>

  </header>


  <!-- Main content -->
  <main>
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer>
    <div class="subscribe">
      <div class="text">
        <div>
          <h4>Subscribe</h4>
          <p>Get updates and latest offers. Stay connected with us.</p>
        </div>
      </div>

      <div class="input">
        <input type="email" placeholder="Write Email" aria-label="email" />
        <button>‚Üí</button>
      </div>
    </div>

    <div class="footer">
      <div class="col-brand">
        <img src="/static/img/Capsul Logo Mark (1).jpeg" alt="Company Logo" class="footer-logo" />

        <p class="brand-content">
          ‚ÄúMedPlus is a reliable healthcare platform <br> dedicated to providing easy access <br> to trusted medical
          information
          and services for <br> better well-being.‚Äù
        </p>

        <div class="social-row">
          <div class="soc"><i class="fab fa-facebook-f"></i></div>
          <div class="soc"><i class="fab fa-twitter"></i></div>
          <div class="soc"><i class="fab fa-linkedin-in"></i></div>
          <div class="soc"><i class="fab fa-instagram"></i></div>
        </div>
      </div>

      <div class="cols">
        <div class="col">
          <h5>About</h5>
          <ul>
            <li><a href="{% url 'home' %}">Home</a></li>
            <li><a href="{% url 'contact' %}">Contact Us</a></li>
            <li><a href="{% url 'product_list' %}"
                class="{% if not selected_category and not filter_type %}active{% endif %}">All Medicines</a></li>
            <li><a href="{% url 'careplan' %}">Care Plan</a></li>
          </ul>
        </div>

        <div class="col">
          <h5>Menu</h5>
          <ul>
            <li><a href="{% url 'privacy' %}">Privacy Policy</a></li>
            <li><a href="{% url 'terms' %}">Terms & Con.</a></li>
            <li><a href="{% url 'return' %}">Return Policy</a></li>
            <li><a href="{% url 'consultdoc' %}">Consult Doctors</a></li>
          </ul>
        </div>

        <div class="col">
          <h5>Services</h5>
          <ul>
            <li><a href="{% url 'product_list' %}"
                class="{% if not selected_category and not filter_type %}active{% endif %}">Order Medicines</a></li>
            <li><a href="{% url 'labtest' %}">Book Tests</a></li>
            <li><a href="{% url 'ayurveda' %}">Ayurveda Care</a></li>
            <li><a href="{% url 'article' %}">Blogs</a></li>
            <li><a href="{% url 'cancercare' %}">Cancer Care</a></li>
          </ul>
        </div>

        <div class="col">
          <h5>Contact</h5>
          <ul>
            <li><a href="tel:+012345678900">Call: +0123 456 789 00</a></li>
            <li>
              <a href="mailto:user@example.com">Email: user@example.com</a>
            </li>
          </ul>
        </div>
      </div>
      <div class="right">
        <iframe class="embed-map-frame" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"
          src="https://maps.google.com/maps?width=600&height=400&hl=en&q=h-15%20noida%20sec-62&t=&z=14&ie=UTF8&iwloc=B&output=embed"></iframe>
      </div>
    </div>

    <div class="bottom">
      <div class="left">
        <a href="{% url 'privacy' %}">Privacy Policy</a>
        <a href="#">Our History</a>
        <a href="#">What We Do</a>
      </div>
      <div class="right">
        ¬© 2025 Example Text. All images are for demo purposes only.
      </div>
    </div>
  </footer>

  <script>
    function floatToBot() {
      const overlay = document.querySelector('.float-to-target');
      const bot = document.querySelector('.chat-toggle');
      if (!overlay || !bot) return;

      const oRect = overlay.getBoundingClientRect();
      const oX = oRect.left + oRect.width / 2;
      const oY = oRect.top + oRect.height / 2;

      const bRect = bot.getBoundingClientRect();
      const bX = bRect.left + bRect.width / 2;
      const bY = bRect.top + bRect.height / 2;

      // Baby‚Äôs custom offsets ‚ù§Ô∏è
      const offsetX = 0;     // left/right adjust
      const offsetY = 25;    // DOWNWARDS adjust

      const diffX = bX - oX + offsetX;
      const diffY = bY - oY + offsetY;

      overlay.style.setProperty('--moveX', diffX + 'px');
      overlay.style.setProperty('--moveY', diffY + 'px');

      overlay.classList.add('animate-to-bot');
    }


    // Call when your overlay appears
    setTimeout(floatToBot, 100);
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const wishlistTable = document.getElementById('wishlist-table');
      const wishlistProductCount = document.getElementById('wishlist-product-count');

      if (!wishlistTable || !wishlistProductCount) return; // exit if elements not found

      function updateWishlistProductCount() {
        const count = wishlistTable.querySelectorAll('tbody tr').length;
        wishlistProductCount.textContent = count + ' Product' + (count !== 1 ? 's' : '') + ' Added';
      }

      updateWishlistProductCount();

      wishlistTable.addEventListener('click', (e) => {
        const target = e.target;

        // Handle quantity increase/decrease
        if (target.classList.contains('wishlist-increase') || target.classList.contains('wishlist-decrease')) {
          const quantitySpan = target.parentElement.querySelector('.wishlist-quantity');
          let quantity = parseInt(quantitySpan.textContent);
          const priceCell = target.closest('tr').querySelector('.wishlist-price');
          const priceText = priceCell.textContent.replace(/[^\d.]/g, '');
          const price = parseFloat(priceText);

          if (target.classList.contains('wishlist-increase')) {
            quantity++;
          } else if (target.classList.contains('wishlist-decrease') && quantity > 1) {
            quantity--;
          }

          quantitySpan.textContent = quantity;
          const totalCell = target.closest('tr').querySelector('.wishlist-total');
          totalCell.textContent = '‚Çπ' + (quantity * price).toFixed(2);
        }

        // Handle delete
        if (target.classList.contains('wishlist-delete-btn')) {
          const row = target.closest('tr');
          const productId = row.dataset.productId;

          fetch("{% url 'delete_wishlist_item' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ product_id: productId })
          })
            .then(res => res.json())
            .then(data => {
              if (data.deleted) {
                row.remove();
                updateWishlistProductCount();
              } else {
                alert("Failed to delete from wishlist.");
              }
            })
            .catch(err => console.error("Error:", err));
        }
      });
    });
  </script>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init();
  </script>

  <script src="{% static 'script.js' %}"></script>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    var options = {
      "key": "{{ RAZORPAY_KEY_ID }}", // from backend
      "amount": "{{ order.amount }}", // in paise
      "currency": "INR",
      "name": "{{ service.name }}",
      "description": "Booking payment",
      "order_id": "{{ order.id }}",
      "handler": function (response) {
        alert("Payment Successful! Payment ID: " + response.razorpay_payment_id);
        // redirect to success page
      }
    };
    var rzp1 = new Razorpay(options);
    document.getElementById('rzp-button').onclick = function (e) {
      rzp1.open();
      e.preventDefault();
    }
  </script>

  <script>
    const bookedSlots = JSON.parse(document.getElementById('booked-slots').textContent);

    const appointmentInput = document.getElementById('appointment_time');

    appointmentInput.addEventListener('input', function () {
      const selected = appointmentInput.value;
      if (bookedSlots.includes(selected)) {
        alert("This slot is already booked! Please choose another time.");
        appointmentInput.value = '';
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');
      var bookedSlots = JSON.parse(document.getElementById('booked-slots').textContent);

      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        slotMinTime: "08:00:00",
        slotMaxTime: "18:00:00",
        events: bookedSlots.map(slot => ({
          title: 'Booked',
          start: slot,
          color: 'red'
        })),
        selectable: true,
        select: function (info) {
          const selected = info.startStr;
          if (bookedSlots.includes(selected)) {
            alert('This slot is already booked!');
          } else {
            document.getElementById('appointment_time').value = selected;
          }
        }
      });

      calendar.render();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    document.querySelectorAll('.consultdoc-acc-item .consultdoc-acc-head').forEach(function (head) {
      head.addEventListener('click', function () {
        var body = head.nextElementSibling;
        var toggle = head.querySelector('.consultdoc-acc-toggle');

        // If this body is already active, close it
        if (body.classList.contains('active')) {
          body.classList.remove('active');
          toggle.textContent = '+';
        } else {
          // Close all others
          document.querySelectorAll('.consultdoc-acc-body').forEach(function (b) {
            b.classList.remove('active');
          });
          document.querySelectorAll('.consultdoc-acc-toggle').forEach(function (t) {
            t.textContent = '+';
          });

          // Open this one
          body.classList.add('active');
          toggle.textContent = '-';
        }
      });
    });
  </script>

  <script>
    const carouselWrapper = document.querySelector('.consultdoc-carousel-wrapper');
    const cards = document.querySelectorAll('.consultdoc-testimonial-card');
    const prevBtn = document.querySelector('.consultdoc-prev');
    const nextBtn = document.querySelector('.consultdoc-next');
    const dotsContainer = document.querySelector('.consultdoc-dots-container');
    let currentIndex = 0;


    cards.forEach((_, i) => {
      const dot = document.createElement('span');
      dot.classList.add('consultdoc-dot');
      if (i === 0) dot.classList.add('active');
      dot.addEventListener('click', () => goToSlide(i));
      dotsContainer.appendChild(dot);
    });


    const dots = document.querySelectorAll('.consultdoc-dot');


    function updateCarousel() {
      cards.forEach((card, i) => {
        card.classList.remove('active');
        dots[i].classList.remove('active');
        if (i === currentIndex) {
          card.classList.add('active');
          dots[i].classList.add('active');
        }
      });
      carouselWrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
    }


    function goToSlide(index) {
      currentIndex = index;
      updateCarousel();
    }


    nextBtn.addEventListener('click', () => {
      currentIndex = (currentIndex + 1) % cards.length;
      updateCarousel();
    });


    prevBtn.addEventListener('click', () => {
      currentIndex = (currentIndex - 1 + cards.length) % cards.length;
      updateCarousel();
    });


    setInterval(() => {
      nextBtn.click();
    }, 4000);
  </script>

  <script>
    (function () {
      const tabButtons = document.querySelectorAll('.cancercare-option');
      const tabContents = document.querySelectorAll('.cancercare-detail');

      function setActiveTab(targetId) {
        // Show the selected tab, hide the others
        tabContents.forEach(content => {
          if (content.id === targetId) {
            content.classList.add('active-tab');  // show
          } else {
            content.classList.remove('active-tab');  // hide
          }
        });

        // Highlight the clicked button
        tabButtons.forEach(btn => {
          const btnTarget = btn.getAttribute('data-target');
          if (btnTarget === targetId) {
            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');
          } else {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
          }
        });
      }

      // Add click event for all buttons
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          setActiveTab(targetId);
        });
      });

      // Initialize first tab as active
      setActiveTab('chemo');
    })();
  </script>


  <script>
    const ayuvedaCounters = document.querySelectorAll('.ayuveda-counter-number');
    const ayuvedaSpeed = 200;

    const animateAyuvedaCounters = () => {
      ayuvedaCounters.forEach(counter => {
        const updateAyuvedaCount = () => {
          const target = +counter.getAttribute('data-target');
          const count = +counter.innerText.replace("+", "");
          const increment = target / ayuvedaSpeed;

          if (count < target) {
            counter.innerText = Math.ceil(count + increment);
            setTimeout(updateAyuvedaCount, 20);
          } else {
            counter.innerText = target + "+";
          }
        };
        updateAyuvedaCount();
      });
    };

    const ayuvedaObserver = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          animateAyuvedaCounters();
          ayuvedaObserver.disconnect();
        }
      });
    }, { threshold: 0.5 });

    ayuvedaObserver.observe(document.querySelector('.ayuveda-counter-section'));
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const modal = document.getElementById("successModal");
      const modalMessage = document.getElementById("modalMessage");
      const closeBtn = document.getElementById("closeModal");
      const messageData = document.getElementById("messageData").dataset.message;

      closeBtn.onclick = () => modal.style.display = "none";

      if (messageData && messageData !== "") {
        modalMessage.textContent = messageData;
        modal.style.display = "flex";

        // Auto-close after 3 seconds
        setTimeout(() => modal.style.display = "none", 3000);
      }
    });
  </script>

  <script>
    function toggleWishlist(element) {
      const productId = element.dataset.productId;

      fetch("{% url 'toggle_wishlist' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ product_id: productId })
      })
        .then(response => response.json())
        .then(data => {
          if (data.added) {
            element.classList.add("saved");
          } else {
            element.classList.remove("saved");
          }
        })
        .catch(error => console.error("Error:", error));
    }
  </script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      $(document).on('click', '#categories-pagination a', function (e) {
        e.preventDefault(); // prevent full reload
        var url = $(this).attr('href');

        $.ajax({
          url: url,
          type: 'get',
          dataType: 'html',
          success: function (data) {
            // Replace the categories grid and pagination
            var newContent = $(data).find('#categories-container').html();
            $('#categories-container').html(newContent);
          }
        });
      });
    });
  </script>

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function addToCart(element) {
      const productId = element.dataset.productId;
      const csrftoken = getCookie('csrftoken');

      fetch("{% url 'add_to_cart' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken
        },
        body: `product_id=${productId}`
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'added') {
            alert('Product added to cart üíñ');
          } else if (data.status === 'quantity_updated') {
            alert(`Product quantity updated: ${data.quantity}`);
          } else {
            alert('Something went wrong!');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error adding product to cart!');
        });
    }
  </script>

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const addButtons = document.querySelectorAll('.wishlist-add-button');

      addButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          const productId = button.dataset.productId;
          const csrftoken = getCookie('csrftoken');

          try {
            const response = await fetch("{% url 'add_to_cart' %}", {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
              },
              body: `product_id=${productId}`
            });

            const data = await response.json();

            if (data.status === 'added') {
              alert('Product added to cart üíñ');
              button.textContent = 'Added';
              button.disabled = true; // Prevent double clicks
            } else if (data.status === 'quantity_updated') {
              alert(`Product quantity updated: ${data.quantity}`);
            } else {
              alert('Something went wrong!');
            }

          } catch (error) {
            console.error('Error:', error);
            alert('Error adding product to cart!');
          }
        });
      });
    });
  </script>

  <script>
    document.querySelectorAll('.product_detail-tab-headers div').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.product_detail-tab-headers div').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      });
    });
  </script>

  <script>
    // Wait for the page to load
    document.addEventListener('DOMContentLoaded', function () {
      // Get main image element
      const mainImage = document.querySelector('.product_detail-main-image img');

      // Get all thumbnails
      const thumbnails = document.querySelectorAll('.product_detail-thumbnails img');

      // Loop through thumbnails and add click event
      thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function () {
          // Change main image src to clicked thumbnail src
          mainImage.src = this.src;

          // Optional: Add active border style
          thumbnails.forEach(img => img.classList.remove('active'));
          this.classList.add('active');
        });
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const bars = document.querySelectorAll('.rating-bar');
      bars.forEach(bar => {
        const percent = bar.getAttribute('data-percent');
        const fill = bar.querySelector('.rating-fill');
        fill.style.width = percent + '%';
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    // Example of booked dates you can fetch dynamically from backend later
    const bookedDates = [
      "2025-10-30",
      "2025-11-02",
      "2025-11-04"
    ];

    // Initialize Flatpickr Calendar
    flatpickr("#appointment_date", {
      dateFormat: "Y-m-d",
      minDate: "today",
      disable: bookedDates,
      altInput: true,
      altFormat: "F j, Y",
      defaultDate: null,
      allowInput: false,
      onReady: function (selectedDates, dateStr, instance) {
        // Add a small tooltip for disabled (booked) dates
        instance.calendarContainer.classList.add('flatpickr-theme');
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    (function () {

      const mobileToggleBtn = document.getElementById('mobileToggle');
      const mobileSlideMenuEl = document.getElementById('mobileMenu');

      if (!mobileToggleBtn || !mobileSlideMenuEl) return;

      /* -----------------------------------
         OPEN/CLOSE MAIN MOBILE SLIDE MENU
      ----------------------------------- */
      mobileToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        mobileSlideMenuEl.classList.toggle('mobile--open');
        mobileToggleBtn.classList.toggle('active');
      });

      /* -----------------------------------
          CLOSE MENU WHEN CLICKING OUTSIDE
      ----------------------------------- */
      document.addEventListener('click', (e) => {
        if (!mobileSlideMenuEl.contains(e.target) && !mobileToggleBtn.contains(e.target)) {
          mobileSlideMenuEl.classList.remove('mobile--open');
          mobileToggleBtn.classList.remove('active');

          // close inner dropdowns
          document
            .querySelectorAll('#mobileMenu .mobile-nav-list > li.mobile--open')
            .forEach(li => li.classList.remove('mobile--open'));

          // close user menu
          const userMenu = document.querySelector('.mobile-user-menu');
          if (userMenu) userMenu.classList.remove('open');
        }
      });

      /* -----------------------------------
         DROPDOWN INSIDE MOBILE NAVIGATION
      ----------------------------------- */
      document.querySelectorAll('#mobileMenu .mobile-nav-list > li').forEach(li => {
        const link = li.querySelector('a');
        const btn = li.querySelector('button.mobile-dropdown-toggle');
        const toggler = btn || link;

        if (!toggler) return;

        const nested = li.querySelector('.mobile-dropdown');
        if (nested) {
          toggler.addEventListener('click', (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            li.classList.toggle('mobile--open');
          });
        }
      });

      /* -----------------------------------
         USER DROPDOWN (LOGIN / PROFILE)
      ----------------------------------- */
      const userToggle = document.querySelector('.mobile-user-toggle');
      const userMenu = document.querySelector('.mobile-user-menu');

      if (userToggle && userMenu) {
        userToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          userMenu.classList.toggle('open');
        });
      }

      /* -----------------------------------
         PREVENT CLOSING WHEN CLICKING INSIDE
      ----------------------------------- */
      mobileSlideMenuEl.addEventListener('click', (e) => {
        e.stopPropagation();
      });

    })();
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const chatToggle = document.querySelector(".chat-toggle");
      const chatWindow = document.querySelector(".chat-window");
      const chatMessages = document.querySelector(".chat-messages");
      const input = document.querySelector(".chat-input");
      const sendBtn = document.querySelector(".send-btn");

      /* ------------------ CHAT WINDOW TOGGLE ------------------ */
      chatToggle.addEventListener("click", () => {
        chatWindow.classList.toggle("open");

        // auto-scroll after animation
        setTimeout(() => {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 200);
      });

      /* ------------------ ADD MESSAGE (USER/BOT) ------------------ */
      function addMessage(text, type, isHTML = false) {
        const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

        const msgDiv = document.createElement("div");
        msgDiv.classList.add("msg", type);

        msgDiv.innerHTML = isHTML
          ? `<div>${text}</div><span class="timestamp">${time}</span>`
          : `<div>${text}</div><span class="timestamp">${time}</span>`;

        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      /* ------------------ BOT TYPING INDICATOR ------------------ */
      function botTyping(show) {
        let typingDiv = document.querySelector(".typing-indicator");

        if (show) {
          if (!typingDiv) {
            typingDiv = document.createElement("div");
            typingDiv.className = "typing-indicator bot-msg";
            typingDiv.innerHTML = `
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        } else {
          if (typingDiv) typingDiv.remove();
        }
      }

      /* ------------------ SEND MESSAGE ------------------ */
      async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, "user-msg");
        input.value = "";

        botTyping(true);

        try {
          const res = await fetch("/chatbot/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({ message: text })
          });

          const data = await res.json();

          botTyping(false);

          if (data.type === "product_card") {
            addMessage(data.html, "bot-msg", true);
          } else {
            addMessage(data.reply, "bot-msg");
          }

        } catch (e) {
          botTyping(false);
          addMessage("Baby I‚Äôm having trouble answering right now üò¢", "bot-msg");
        }
      }

      /* ------------------ SEND ON CLICK ------------------ */
      sendBtn.addEventListener("click", sendMessage);


      /* ------------------ SEND ON ENTER ------------------ */
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });

      /* ------------------ CSRF HELPER ------------------ */
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
              cookieValue = cookie.substring(name.length + 1);
              break;
            }
          }
        }
        return cookieValue;
      }

    }); // DOMContentLoaded END

    /* ------------------ WELCOME BOT OVERLAY ANIMATION ------------------ */
    const overlay = document.getElementById("welcome-bot-overlay");
    const bigBot = document.getElementById("welcomeBotAvatar");
    const smallBot = document.querySelector(".chat-toggle");

    if (overlay && bigBot && smallBot) {

      setTimeout(() => {
        overlay.style.opacity = "0";

        setTimeout(() => {
          overlay.style.display = "none";

          document.body.appendChild(bigBot);

          const toggleRect = smallBot.getBoundingClientRect();

          bigBot.style.position = "fixed";
          bigBot.style.left = "50%";
          bigBot.style.top = "50%";
          bigBot.style.transform = "translate(-50%, -50%) scale(1)";
          bigBot.offsetHeight;

          bigBot.classList.add("float-to-target");
          bigBot.style.transition = "left 2.5s ease, top 2.5s ease";
          bigBot.style.left = `${toggleRect.left + toggleRect.width / 2}px`;
          bigBot.style.top = `${toggleRect.top - 40}px`;

          setTimeout(() => {
            bigBot.style.display = "none";
            smallBot.style.display = "block";
            smallBot.classList.add("shine");
          }, 2500);

        }, 1000);
      }, 2000);
    }
  </script>

  <script>
    const chatToggle = document.querySelector(".chat-toggle");
    let isDragging = false;
    let offsetX = 0;
    let offsetY = 0;

    chatToggle.addEventListener("mousedown", (e) => {
      isDragging = true;
      offsetX = e.clientX - chatToggle.getBoundingClientRect().left;
      offsetY = e.clientY - chatToggle.getBoundingClientRect().top;
      chatToggle.style.transition = "none"; // remove hover scale while dragging
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      let x = e.clientX - offsetX;
      let y = e.clientY - offsetY;

      // Keep within window bounds
      const maxX = window.innerWidth - chatToggle.offsetWidth;
      const maxY = window.innerHeight - chatToggle.offsetHeight;
      x = Math.max(0, Math.min(x, maxX));
      y = Math.max(0, Math.min(y, maxY));

      chatToggle.style.left = x + "px";
      chatToggle.style.top = y + "px";
    });

    document.addEventListener("mouseup", () => {
      if (!isDragging) return;
      isDragging = false;
      chatToggle.style.transition = "transform 0.3s"; // restore hover scale
    });
  </script>

</body>

</html>